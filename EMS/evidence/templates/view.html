<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evidence Search</title>
  <link rel="stylesheet" href="{% static 'evidence/css/View.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
  {% include 'nav.html' %}


  <!-- Search Container -->
  <div style="margin-top:100px;" class="search-container">
    <input type="text" id="search-bar" placeholder="Enter Hash ID to find related case evidence" />
    <button class="search-btn" id="search-btn">Search</button>
  </div>
  </header>

  <!-- Evidence Cards Container -->
  <div class="evidence-container" id="evidenceContainer">
    <!-- Example Card 1 -->
    <div class="evidence-card">
      <div class="card-content">
         
      </div>
    </div>
  </div>
  {% include 'footer.html' %}

  <script>
 

const web3 = new Web3(window.ethereum); 

const contractABI =  [
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "bytes32",
        "name": "uniqueID",
        "type": "bytes32"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "hashID",
        "type": "string"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "userAddress",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timeStamp",
        "type": "uint256"
      }
    ],
    "name": "HashStored",
    "type": "event"
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "hashID",
        "type": "string"
      }
    ],
    "name": "storeHash",
    "outputs": [
      {
        "internalType": "bytes32",
        "name": "",
        "type": "bytes32"
      }
    ],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "uniqueID",
        "type": "bytes32"
      }
    ],
    "name": "getHashDetails",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "",
        "type": "bytes32"
      }
    ],
    "name": "hashRecords",
    "outputs": [
      {
        "internalType": "string",
        "name": "hashID",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "userAddress",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "timeStamp",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "idCounter",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const contractAddress = '0x1b94433e9ec8b33328d8b6a42334c3586b33257d';  // Replace with your deployed contract address

// Create contract instance
const contract = new web3.eth.Contract(contractABI, contractAddress);

// Function to retrieve IPFS hash
async function getIPFSHash(hashID) {
    try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

        // Call the getHashDetails method from the smart contract
        const result = await contract.methods.getHashDetails(hashID).call({ from: accounts[0] });

        // The first item in result is the IPFS hash
        const ipfsHash = result[0];
        console.log("IPFS Hash: ", ipfsHash);

        await sendHashToPython(ipfsHash);

        return ipfsHash;
    } catch (error) {
        console.error("Error retrieving IPFS hash:", error);
    }
}

// Function to send the IPFS hash to the Python backend
async function sendHashToPython(ipfsHash) {
  try {
      const response = await fetch('http://127.0.0.1:8000/process_ipfs/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ipfsHash: ipfsHash }),
      });

      if (response.ok) {
          const data = await response.json();
          console.log('Response from Python backend:', data);

          const crimeData = data.crime_data;
          const evidenceFiles = data.evidence_files;

          updateUI(crimeData, evidenceFiles);
      } else {
          console.error('Error sending data to Python backend:', response.statusText);
      }
  } catch (error) {
      console.error('Error sending IPFS hash to Python:', error);
  }
}

// Handle the search button click
document.getElementById('search-btn').addEventListener('click', async () => {
    const hashID = document.getElementById('search-bar').value;
    
    if (!hashID) {
        alert("Please enter a Hash ID");
        return;
    }
    // Get evidence data from the contract and IPFS
    const evidence = await getIPFSHash(hashID);

    await sendHashToPython(hashID);
});


// Function to update the UI with crime data and evidence files
function updateUI(crimeData, evidenceFiles) {
  // Update crime data fields
  const evidenceContainer = document.getElementById('evidenceContainer');
  evidenceContainer.innerHTML = `
    <div class="evidence-card">
      <div class="card-content">
        <h2>${crimeData.name}</h2>
        <p><strong>Crime Name:</strong> ${crimeData.crime}</p>
        <p><strong>Nationality:</strong> ${crimeData.nationality}</p>
        <p><strong>National ID Card Number:</strong> ${crimeData.nationalId}</p>
        <p><strong>Description:</strong> ${crimeData.description}</p>
        <p>Evidence Files:</p>
        <ul>
          ${evidenceFiles.map(file => `<li><a href="https://gateway.pinata.cloud/ipfs/${file}" target="_blank">${file}</a></li>`).join('')}
        </ul>
      </div>
    </div>
  `;
}
  </script>

  
</body>
</html>
